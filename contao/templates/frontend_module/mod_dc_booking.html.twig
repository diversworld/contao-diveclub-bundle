{#
    Das Template verwendet eine flache Block-Struktur, um die Erweiterbarkeit im Contao Template Studio zu maximieren.
    Jeder Block kann einzeln überschrieben werden. Wichtig: Definieren Sie Blöcke in Ihrem Kind-Template
    immer auf der obersten Ebene (nicht innerhalb anderer Blöcke verschachtelt).
#}
{% extends "@Contao/frontend_module/_base.html.twig" %}

{% block content %}
    {% set assets = assets ?? [] %} {# Standardwert setzen, falls assets nicht existiert #}
    {{ block('booking_headline') }}
    {{ block('booking_intro') }}
    {{ block('booking_selection') }}
    {{ block('booking_actions_summary') }}
    {{ block('booking_items_selection') }}
{% endblock %}

{% block booking_headline %}
    <h2>Reservierungssystem</h2>
{% endblock %}

{% block booking_intro %}
    <div class="row">
        <div class="col m12">
            <p>Bitte wähle die gewünschten Ausrüstungsteile aus der Liste. Mit dem Absenden des Formulars, werden die
                gewählten Teile für Dich vorgemerkt.</p>
            {% if rentalConditions is not empty %}
                {{ rentalConditions|raw }}
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block booking_selection %}
    <div class="row">
        <div class="col m3">
            {{ block('category_selection') }}
        </div>
        <div class="col m3">&nbsp;</div>
        <div class="col m3">
            {{ block('current_user_display') }}
        </div>
        <div class="col m3">
            {{ block('member_selection') }}
        </div>
    </div>
{% endblock %}

{% block category_selection %}
    <form method="get" id="categorySelectionForm" action="{{ action }}">
        <input type="hidden" name="REQUEST_TOKEN" value="{{ request_token }}">
        <input type="hidden" name="FORM_SUBMIT" value="reservationSelectSubmit"/>
        <label for="category">Kategorie auswählen:</label>
        <select name="category" id="category" class="form-control" onchange="this.form.submit();">
            <option value="">-- Bitte auswählen --</option>
            {% for key, label in categories %}
                <option value="{{ key }}" {% if key == selectedCategory %}selected{% endif %}>
                    {{ label }}
                </option>
            {% endfor %}
        </select>
    </form>
{% endblock %}

{% block current_user_display %}
    <label for="currentUser">Angemeldeter Benutzer:</label>
    <p>{{ currentUser.userFullName| default('Gast') }}</p>
{% endblock %}

{% block member_selection %}
    <form method="POST" action="{{ action }}">
        <input type="hidden" name="REQUEST_TOKEN" value="{{ request_token }}">
        <input type="hidden" name="FORM_SUBMIT" value="reservation_select_member">
        <label for="reservedFor">Reservieren für:</label>
        <select name="reservedFor" id="reservedFor" class="form-control" onchange="this.form.submit();">
            <option value="">{{ currentUser.userFullName| default('Gast') }}</option>
            {% for member in memberList %}
                <option value="{{ member.id }}" {% if member.id == selectedMember %}selected{% endif %}>
                    {{ member.firstname }} {{ member.lastname }}
                </option>
            {% endfor %}
        </select>
    </form>
{% endblock %}

{% block booking_actions_summary %}
    <div class="row">
        <div class="col m6">
            {{ block('booking_main_actions') }}
        </div>
        <div class="col m6">
            {{ block('booking_messages') }}
        </div>
        <div class="col m12">
            {{ block('booking_summary') }}
        </div>
    </div>
{% endblock %}

{% block booking_main_actions %}
    <form method="POST" id="reservationSaveForm" action="{{ action }}">
        <input type="hidden" name="FORM_SUBMIT" value="reservationSubmit"/>
        <input type="hidden" name="REQUEST_TOKEN" value="{{ request_token }}">
        <input type="hidden" name="userId" value="{{ currentUser.userId }}">
        <button type="submit" name="action" value="save" class="btn btn-primary">Speichern</button>
        <button type="submit" name="action" value="cancel" class="btn btn-danger">Abbrechen</button>
    </form>
{% endblock %}

{% block booking_messages %}
    {% if messageSave is defined and messageSave|trim is not empty %}
        <div class="alert-container">
            {{ messageSave|raw }}
        </div>
    {% endif %}
{% endblock %}

{% block booking_summary %}
    {% if storedAssets is not empty %}
        <h3>Vorgemerkte Reservierungen:</h3>
        <ul>
            {% for asset in storedAssets %}
                <li>{{ asset }}</li>
            {% endfor %}
        </ul>
        <p><strong>Leihgebühr gesamt: {{ totalRentalFee|number_format(2, '.', ',') }} €</strong></p>
    {% else %}
        <p>Es wurden noch keine Reservierungen vorgenommen.</p>
    {% endif %}
{% endblock %}

{% block booking_items_selection %}
    <div class="row">
        <form method="POST" id="reservationForm" action="{{ action }}">
            <input type="hidden" name="FORM_SUBMIT" value="reservationItems_submit"/>
            <input type="hidden" name="REQUEST_TOKEN" value="{{ request_token }}">
            <input type="hidden" name="userId" value="{{ currentUser.userId }}">

            <div class="col m12">
                {{ block('reserve_selected_button') }}
                {{ block('available_assets') }}
            </div>
        </form>
    </div>
{% endblock %}

{% block reserve_selected_button %}
    <div class="col-md-6">
        <button type="submit" name="action" value="reserve" class="btn btn-primary">Ausgewählte vormerken
        </button>
    </div>
{% endblock %}

{% block available_assets %}
    <div class="reservation-assets">
        <h2>Verfügbare Ausrüstungsgegenstände</h2>
        {% if selectedCategory == 'tl_dc_equipment' %}
            {{ block('grouped_assets') }}
        {% else %}
            {{ block('flat_assets') }}
        {% endif %}
    </div>
{% endblock %}

{% block grouped_assets %}
    {# Kategorie equipment_types benötigt groupedAssets #}
    {% if groupedAssets is not empty %}
        {% for typeName, subTypes in groupedAssets %}
            <h2>{{ typeName }}</h2> {# Übergeordneter Typ anzeigen (z. B. "Anzüge") #}

            {% for subTypeName, assets in subTypes %}
                <h3>{{ subTypeName }}</h3> {# Subtyp anzeigen (z. B. "shorties") #}

                <table class="table table-striped">
                    {{ block('asset_table_head_equipment') }}
                    <tbody>
                    {% for asset in assets %}
                        {{ block('asset_row_equipment') }}
                    {% endfor %}
                    </tbody>
                </table>
            {% endfor %}
        {% endfor %}
    {% else %}
        <p>Keine Ausrüstung verfügbar.</p>
    {% endif %}
{% endblock %}

{% block asset_table_head_equipment %}
    <thead>
    <tr>
        <th>Inventarnummer</th>
        <th>Status</th>
        <th>Hersteller</th>
        <th>Modell</th>
        <th>Farbe</th>
        <th>Größe</th>
        <th>Leihgebühr</th>
        <th>Reservieren</th>
    </tr>
    </thead>
{% endblock %}

{% block asset_row_equipment %}
    <tr>
        <td>{{ asset.title|default('Keine Daten') }}</td>
        <td>{{ asset.status|default('Keine Daten') }}</td>
        <td>{{ asset.manufacturer|default('Keine Daten') }}</td>
        <td>{{ asset.model|default('Keine Daten') }}</td>
        <td>{{ asset.color|default('Keine Daten') }}</td>
        <td>{{ asset.size|default('Keine Daten') }}</td>
        <td>{{ asset.price|default('Keine Daten') }}</td>
        <td style="width: 40px;">
            <div class="widget widget-checkbox">
                {{ reservationCheckboxes[asset.id]|raw }}
            </div>
            <input type="hidden" name="category" value="{{ asset.category }}">
            <input type="hidden" name="type" value="{{ asset.typeId }}">
            <input type="hidden" name="subType" value="{{ asset.subTypeId }}">
        </td>
    </tr>
{% endblock %}

{% block flat_assets %}
    {# Alle anderen Kategorien arbeiten direkt mit assets #}
    {% if assets is not empty %}
        <table class="table table-striped">
            {{ block('asset_table_head_flat') }}
            <tbody>
            {% for asset in assets %}
                {{ block('asset_row_flat') }}
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Keine Ausrüstung verfügbar.</p>
    {% endif %}
{% endblock %}

{% block asset_table_head_flat %}
    <thead>
    <tr>
        {% if selectedCategory == 'tl_dc_tanks' %}
            <th>Inventarnummer</th>
            <th>Größe</th>
            <th>Status</th>
            <th>Leihgebühr</th>
            <th>Reservieren</th>
        {% elseif selectedCategory == 'tl_dc_regulators' %}
            <th>Inventarnummer</th>
            <th>Hersteller</th>
            <th>SN 1. Stufe</th>
            <th>Modell 1. Stufe</th>
            <th>Modell 2. Stufe (Primär)</th>
            <th>Modell 2. Stufe (Sekundär)</th>
            <th>Status</th>
            <th>Leihgebühr</th>
            <th>Reservieren</th>
        {% endif %}
    </tr>
    </thead>
{% endblock %}

{% block asset_row_flat %}
    <tr>
        {% if selectedCategory == 'tl_dc_tanks' %}
            <td>{{ asset.title|default('Keine Daten') }}</td>
            <td>{{ asset.size|default('Keine Daten') }}</td>
            <td>{{ asset.status|default('Keine Daten') }}</td>
            <td>{{ asset.price|default('Keine Daten') }}</td>
            <td style="width: 40px;">
                <div class="widget widget-checkbox">
                    {{ reservationCheckboxes[asset.id]|raw }}
                </div>
                <input type="hidden" name="category" value="{{ asset.category }}">
            </td>
        {% elseif selectedCategory == 'tl_dc_regulators' %}
            <td>{{ asset.title|default('Keine Daten') }}</td>
            <td>{{ asset.manufacturer|default('Keine Daten') }}</td>
            <td>{{ asset.serialNumber1st|default('Keine Daten') }}</td>
            <td>{{ asset.regModel1st|default('Keine Daten') }}</td>
            <td>{{ asset.regModel2ndPri|default('Keine Daten') }}</td>
            <td>{{ asset.regModel2ndSec|default('Keine Daten') }}</td>
            <td>{{ asset.status|default('Keine Daten') }}</td>
            <td>{{ asset.price|default('Keine Daten') }}</td>
            <td style="width: 40px;">
                <div class="widget widget-checkbox">
                    {{ reservationCheckboxes[asset.id]|raw }}
                    <input type="hidden" name="category" value="{{ asset.category }}">
                </div>
            </td>
        {% endif %}
    </tr>
{% endblock %}
