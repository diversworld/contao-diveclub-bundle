{#
    Das Template verwendet eine flache Block-Struktur, um die Erweiterbarkeit im Contao Template Studio zu maximieren.
    Jeder Block kann einzeln überschrieben werden. Wichtig: Definieren Sie Blöcke in Ihrem Kind-Template
    immer auf der obersten Ebene (nicht innerhalb anderer Blöcke verschachtelt).
#}
{% extends "@Contao/frontend_module/_base.html.twig" %}

{% block content %}
    {% set container_attributes = attrs().addClass('mod_dc_course_progress').mergeWith(container_attributes|default) %}
    <div{{ container_attributes }}>
        {% if not isLoggedIn %}
            {{ block('not_logged_in') }}
        {% elseif notFound %}
            {{ block('not_found') }}
        {% else %}
            {{ block('progress_header') }}
            {{ block('progress_exercises') }}
            {{ block('progress_schedule') }}
            {{ block('progress_actions') }}
        {% endif %}
    </div>
{% endblock %}

{% block not_logged_in %}
    <p class="message message--info">Bitte melden Sie sich an.</p>
{% endblock %}

{% block not_found %}
    <p class="message message--error">Die gewünschte Kurs-Zuweisung wurde nicht gefunden oder Sie haben keine
        Berechtigung diese einzusehen.</p>
{% endblock %}

{% block progress_header %}
    <h2>{{ labels.headline }}</h2>
{% endblock %}

{% block progress_exercises %}
    <div class="progress-section progress-section--exercises">
        <h3>{{ labels.exercises }}</h3>
        {% if modules is empty %}
            {{ block('no_exercises') }}
        {% else %}
            {{ block('modules_list') }}
        {% endif %}
    </div>

    <script>
        document.querySelectorAll('.module-header').forEach(header => {
            header.addEventListener('click', () => {
                const moduleBody = header.nextElementSibling;
                moduleBody.style.display = moduleBody.style.display === 'none' ? 'block' : 'none';
                header.classList.toggle('is-open');
            });
        });

        function toggleExercise(id, currentStatus) {
            const newStatus = currentStatus === 'completed' ? 'pending' : 'completed';
            const formData = new FormData();
            formData.append('action', 'toggleExerciseStatus');
            formData.append('exerciseId', id);
            formData.append('status', newStatus);

            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Einfachste Lösung: Seite neu laden
                } else {
                    alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
                }
            });
        }
    </script>

    <style>
        .module-item { border: 1px solid #ddd; margin-bottom: 10px; border-radius: 4px; overflow: hidden; }
        .module-header { background: #f5f5f5; padding: 10px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .module-header:hover { background: #eee; }
        .module-header h4 { margin: 0; font-size: 1.1em; }
        .module-header::after { content: '▶'; transition: transform 0.3s; }
        .module-header.is-open::after { transform: rotate(90deg); }
        .module-body { padding: 0; border-top: 1px solid #ddd; }
        .exercises-table { margin-bottom: 0; width: 100%; border-collapse: collapse; }
        .exercises-table th, .exercises-table td { padding: 10px 15px; text-align: left; border-bottom: 1px solid #eee; }
        .status--completed { background-color: #dff0d8; }
        .btn-toggle { padding: 2px 8px; font-size: 0.85em; cursor: pointer; }
    </style>
{% endblock %}

{% block no_exercises %}
    <p class="message message--info">Für diesen Kurs sind noch keine Übungen hinterlegt.</p>
{% endblock %}

{% block modules_list %}
    <div class="modules-list">
        {% for moduleId, module in modules %}
            <div class="module-item">
                <div class="module-header">
                    <h4>{{ module.title }}</h4>
                </div>
                <div class="module-body" style="display: none;">
                    {% if module.exercises is empty %}
                        <p style="padding: 15px;">Keine Übungen für dieses Modul.</p>
                    {% else %}
                        <table class="exercises-table">
                            <thead>
                                <tr>
                                    <th>Übung</th>
                                    <th>Status</th>
                                    {% if isInstructor %}<th>Aktion</th>{% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for exercise in module.exercises %}
                                    <tr class="status--{{ exercise.status }}">
                                        <td>{{ exercise.title }}</td>
                                        <td><span class="status-label">{{ exercise.status_label }}</span></td>
                                        {% if isInstructor %}
                                            <td>
                                                <button class="btn btn-toggle" onclick="toggleExercise({{ exercise.id }}, '{{ exercise.status }}')">
                                                    {% if exercise.status == 'completed' %}Wieder öffnen{% else %}Abschließen{% endif %}
                                                </button>
                                            </td>
                                        {% endif %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
{% endblock %}

{% block progress_schedule %}
    {% if schedule is not empty %}
        <div class="progress-section progress-section--schedule">
            <h3>{{ labels.schedule }}</h3>
            {{ block('schedule_table') }}
        </div>
    {% endif %}
{% endblock %}

{% block schedule_table %}
    <table class="table schedule-table">
        {{ block('schedule_table_head') }}
        <tbody>
        {% for item in schedule %}
            {{ block('schedule_row') }}
        {% endfor %}
        </tbody>
    </table>
{% endblock %}

{% block schedule_table_head %}
    <thead>
    <tr>
        <th>Datum/Zeit</th>
        <th>Modul / Übung</th>
        <th>Ort</th>
        <th>Hinweis</th>
    </tr>
    </thead>
{% endblock %}

{% block schedule_row %}
    <tr>
        <td>{{ item.planned_at }}</td>
        <td>
            <strong>{{ item.module }}</strong><br>
            {{ item.exercise }}
        </td>
        <td>{{ item.location }}</td>
        <td>{{ item.notes }}</td>
    </tr>
{% endblock %}

{% block progress_actions %}
    <div class="actions">
        <a href="javascript:history.back()" class="btn btn-default">Zurück zur Übersicht</a>
    </div>
{% endblock %}
